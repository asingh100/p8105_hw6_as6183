---
title: "p8105_hw6_as6183"
output: github_document
---
# Problem 1
```{r}
library(tidyverse)

data = read.csv("./data/homicide-data.csv")%>%
  mutate(city_state = str_c(city,state,sep=", "),
         solved = ifelse(disposition != "Closed by arrest",0,1))%>%
  filter(city_state != "Dallas, TX" & city_state != "Phoenix, AZ" & city_state != "Kansas City, MO" & city_state != "Tulsa, AL")%>%
  filter(victim_race == "Black" | victim_race == "White")%>%
  mutate(victim_age = as.numeric(victim_age),
         victim_race = fct_relevel(victim_race, "White"))

glm_Bmore = data%>%
  filter(city_state == "Baltimore, MD")%>%
  glm(formula = solved~victim_age+victim_sex+victim_race,data = ., family=binomial)

glm_Bmore%>%
   broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  cbind(exp(confint(glm_Bmore)))%>%
  rename(conf.low = `2.5 %`,
         conf.high = `97.5 %`)%>%
  select(term, log_OR = estimate, OR, p.value,conf.low,conf.high)%>% 
  knitr::kable(digits = 3)

glm_all =
  data %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = map(data, ~ glm(formula = solved~victim_age+victim_sex+victim_race,data = .x, family=binomial)),
    results = map(models, broom::tidy)) %>%
  mutate(map_dfr(.x = models, .f = ~exp(confint(.x,'victim_raceBlack'))))%>% 
  select(-data,-models)%>%
  unnest(results)%>% 
  mutate(OR = exp(estimate)) %>%
  filter(term == "victim_raceBlack")%>%
  rename(conf.low = `2.5 %`,
         conf.high = `97.5 %`)%>%
  select(city_state,term,OR, p.value,conf.low,conf.high) 

glm_all%>%
   ggplot(aes(x = reorder(city_state,OR), y = OR)) +
   geom_bar(stat="identity", fill = "light blue", col = "white")+
   geom_errorbar(aes(ymin = conf.low, ymax = conf.high))+
   xlab("City")+
   ylab("Odds Ratio for solving Homicides comparing Black to White Victims")+
   ggtitle("Odds Ratio for Solving Homicides based on Victim's Race by City")+
   theme(
     axis.text.x = element_text
     (
       size=8,
       angle=90,
       vjust = 0.5, 
       hjust = 1
       ),
     axis.title.y = element_text(size=8),
     plot.title=element_text(size=11)
         )
```

# Problem 2: 

```{r}
data = read.csv("./data/birthweight.csv")%>%
  mutate(babysex = factor(babysex),
         frace = factor(frace),
         malform = factor(malform),
         mrace = factor(mrace),
         fincome = factor(fincome))
```

Proposed Regression Model:

```{r}
library(modelr)

proposed_model = lm(bwt~frace+malform+mrace+fincome+smoken,data = data)

proposed_model%>% 
  broom::tidy() %>% 
  select(term, estimate, p.value)%>%
  knitr::kable(digits=3)

data%>%
  modelr::add_residuals(proposed_model)%>%
  modelr::add_predictions(proposed_model)%>%
  ggplot(aes(pred,resid))+geom_point()
```

**Description of Modeling Process and Graph:**

```{r}
cv_df = 
  crossv_mc(data, 100)%>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(
    proposed_model  = map(train, ~lm(bwt~frace+malform+mrace+fincome+smoken,data = .x)),
    model_1  = map(train, ~lm(bwt~gaweeks+blength,data = .x)),
    model_2  = map(train, ~lm(bwt~bhead*blength+blength*babysex+bhead*babysex+bhead*babysex*blength,data = .x))) %>% 
  mutate(
    rmse_proposed = map2_dbl(proposed_model, test, ~rmse(model = .x, data = .y)),
    rmse_1 = map2_dbl(model_1, test, ~rmse(model = .x, data = .y)),
    rmse_2 = map2_dbl(model_2, test, ~rmse(model = .x, data = .y)))
```