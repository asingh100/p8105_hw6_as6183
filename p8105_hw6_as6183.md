p8105\_hw6\_as6183
================

# Problem 1

``` r
library(tidyverse)
```

    ## -- Attaching packages ---------------------------------------- tidyverse 1.3.0 --

    ## v ggplot2 3.3.2     v purrr   0.3.4
    ## v tibble  3.0.3     v dplyr   1.0.1
    ## v tidyr   1.1.2     v stringr 1.4.0
    ## v readr   1.3.1     v forcats 0.5.0

    ## -- Conflicts ------------------------------------------- tidyverse_conflicts() --
    ## x dplyr::filter() masks stats::filter()
    ## x dplyr::lag()    masks stats::lag()

``` r
data = read.csv("./data/homicide-data.csv")%>%
  mutate(city_state = str_c(city,state,sep=", "),
         solved = ifelse(disposition != "Closed by arrest",0,1))%>%
  filter(city_state != "Dallas, TX" & city_state != "Phoenix, AZ" & city_state != "Kansas City, MO" & city_state != "Tulsa, AL")%>%
  filter(victim_race == "Black" | victim_race == "White")%>%
  mutate(victim_age = as.numeric(victim_age),
         victim_race = fct_relevel(victim_race, "White"))
```

    ## Warning: Problem with `mutate()` input `victim_age`.
    ## x NAs introduced by coercion
    ## i Input `victim_age` is `as.numeric(victim_age)`.

    ## Warning in mask$eval_all_mutate(dots[[i]]): NAs introduced by coercion

``` r
glm_Bmore = data%>%
  filter(city_state == "Baltimore, MD")%>%
  glm(formula = solved~victim_age+victim_sex+victim_race,data = ., family=binomial)

glm_Bmore%>%
   broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  cbind(exp(confint(glm_Bmore)))%>%
  rename(conf.low = `2.5 %`,
         conf.high = `97.5 %`)%>%
  select(term, log_OR = estimate, OR, p.value,conf.low,conf.high)%>% 
  knitr::kable(digits = 3)
```

    ## Waiting for profiling to be done...

|                   | term              | log\_OR |    OR | p.value | conf.low | conf.high |
| :---------------- | :---------------- | ------: | ----: | ------: | -------: | --------: |
| (Intercept)       | (Intercept)       |   1.152 | 3.164 |   0.000 |    1.998 |     5.057 |
| victim\_age       | victim\_age       | \-0.007 | 0.993 |   0.043 |    0.987 |     1.000 |
| victim\_sexMale   | victim\_sexMale   | \-0.854 | 0.426 |   0.000 |    0.324 |     0.558 |
| victim\_raceBlack | victim\_raceBlack | \-0.842 | 0.431 |   0.000 |    0.305 |     0.606 |

``` r
glm_all =
  data %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = map(data, ~ glm(formula = solved~victim_age+victim_sex+victim_race,data = .x, family=binomial)),
    results = map(models, broom::tidy)) %>%
  mutate(map_dfr(.x = models, .f = ~exp(confint(.x,'victim_raceBlack'))))%>% 
  select(-data,-models)%>%
  unnest(results)%>% 
  mutate(OR = exp(estimate)) %>%
  filter(term == "victim_raceBlack")%>%
  rename(conf.low = `2.5 %`,
         conf.high = `97.5 %`)%>%
  select(city_state,term,OR, p.value,conf.low,conf.high) 
```

    ## Waiting for profiling to be done...

    ## Warning: Problem with `mutate()` input `..1`.
    ## x glm.fit: fitted probabilities numerically 0 or 1 occurred
    ## i Input `..1` is `map_dfr(.x = models, .f = ~exp(confint(.x, "victim_raceBlack")))`.

    ## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

    ## Waiting for profiling to be done...

    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...

    ## Warning: Problem with `mutate()` input `..1`.
    ## x glm.fit: fitted probabilities numerically 0 or 1 occurred
    ## i Input `..1` is `map_dfr(.x = models, .f = ~exp(confint(.x, "victim_raceBlack")))`.
    
    ## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...

    ## Warning: Problem with `mutate()` input `..1`.
    ## x glm.fit: fitted probabilities numerically 0 or 1 occurred
    ## i Input `..1` is `map_dfr(.x = models, .f = ~exp(confint(.x, "victim_raceBlack")))`.
    
    ## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...
    ## Waiting for profiling to be done...

``` r
glm_all%>%
   ggplot(aes(x = reorder(city_state,OR), y = OR)) +
   geom_bar(stat="identity", fill = "light blue", col = "white")+
   geom_errorbar(aes(ymin = conf.low, ymax = conf.high))+
   xlab("City")+
   ylab("Odds Ratio for solving Homicides comparing Black to White Victims")+
   ggtitle("Odds Ratio for Solving Homicides based on Victim's Race by City")+
   theme(
     axis.text.x = element_text
     (
       size=8,
       angle=90,
       vjust = 0.5, 
       hjust = 1
       ),
     axis.title.y = element_text(size=8),
     plot.title=element_text(size=11)
         )
```

![](p8105_hw6_as6183_files/figure-gfm/unnamed-chunk-1-1.png)<!-- -->

# Problem 2:

``` r
data = read.csv("./data/birthweight.csv")%>%
  mutate(babysex = factor(babysex),
         frace = factor(frace),
         malform = factor(malform),
         mrace = factor(mrace),
         fincome = factor(fincome))
```

Proposed Regression Model:

``` r
library(modelr)
```

    ## Warning: package 'modelr' was built under R version 4.0.3

``` r
proposed_model = lm(bwt~frace+malform+mrace+smoken,data = data)

proposed_model%>% 
  broom::tidy() %>% 
  select(term, estimate, p.value)%>%
  knitr::kable(digits=3)
```

| term        |  estimate | p.value |
| :---------- | --------: | ------: |
| (Intercept) |  3335.871 |   0.000 |
| frace2      |  \-78.961 |   0.332 |
| frace3      |  \-29.257 |   0.811 |
| frace4      |  \-80.202 |   0.310 |
| frace8      |   \-2.281 |   0.986 |
| malform1    |  \-20.422 |   0.870 |
| mrace2      | \-282.153 |   0.001 |
| mrace3      | \-158.533 |   0.211 |
| mrace4      | \-173.247 |   0.029 |
| smoken      |  \-11.201 |   0.000 |

``` r
data%>%
  modelr::add_residuals(proposed_model)%>%
  modelr::add_predictions(proposed_model)%>%
  ggplot(aes(pred,resid))+geom_point()
```

![](p8105_hw6_as6183_files/figure-gfm/unnamed-chunk-3-1.png)<!-- -->

**Description of Modeling Process and Graph:**

``` r
cv_df = 
  crossv_mc(data, 100)%>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(
    proposed_model  = map(train, ~lm(bwt~frace+malform+mrace+smoken,data = .x)),
    model_1  = map(train, ~lm(bwt~gaweeks+blength,data = .x)),
    model_2  = map(train, ~lm(bwt~bhead*blength+blength*babysex+bhead*babysex+bhead*babysex*blength,data = .x))) %>% 
  mutate(
    rmse_proposed = map2_dbl(proposed_model, test, ~rmse(model = .x, data = .y)),
    rmse_1 = map2_dbl(model_1, test, ~rmse(model = .x, data = .y)),
    rmse_2 = map2_dbl(model_2, test, ~rmse(model = .x, data = .y)))

cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

![](p8105_hw6_as6183_files/figure-gfm/unnamed-chunk-4-1.png)<!-- -->

# Problem 3:

``` r
library(rnoaa)
```

    ## Registered S3 method overwritten by 'hoardr':
    ##   method           from
    ##   print.cache_info httr

``` r
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

    ## using cached file: C:\Users\13038\AppData\Local\Cache/R/noaa_ghcnd/USW00094728.dly

    ## date created (size, mb): 2020-11-23 08:30:22 (7.547)

    ## file min/max dates: 1869-01-01 / 2020-11-30

``` r
boot_sample = function(df) {
  sample_frac(df, replace = TRUE)
}

boot_straps = 
  data_frame(
    strap_number = 1:5000,
    strap_sample = rerun(5000, boot_sample(weather_df))
  )
```

    ## Warning: `data_frame()` is deprecated as of tibble 1.1.0.
    ## Please use `tibble()` instead.
    ## This warning is displayed once every 8 hours.
    ## Call `lifecycle::last_warnings()` to see where this warning was generated.

``` r
bootstrap_results = 
  boot_straps %>% 
  mutate(
    models = map(strap_sample, ~lm(tmax ~ tmin, data = .x) ),
    r2 = map(models,broom::glance),
    results = map(models, broom::tidy)) %>% 
  select(-strap_sample, -models) %>% 
  unnest(results)%>%
  select(-c(p.value,statistic,std.error))%>%
  unnest(r2)%>%
  select(strap_number,term,estimate,r.squared)%>%
  pivot_wider(names_from = term, values_from = estimate)%>%
  mutate(log = log(`(Intercept)`*tmin))

library(patchwork)

plot_1 = bootstrap_results%>%
   ggplot(aes(x = r.squared)) + 
  geom_density()+
  xlab("r.squared")+
  ylab("density")+
  xlim(c(0.87,0.96))+
  ggtitle("Distribution of R squared values")

plot_2 = bootstrap_results%>%
  ggplot(aes(x = log)) + 
  geom_density()+
  xlab("log(B0*B1)")+
  ylab("density")+
  ggtitle("Distribution of log(B0*B1) values")

plot_1 + plot_2
```

![](p8105_hw6_as6183_files/figure-gfm/unnamed-chunk-5-1.png)<!-- -->

**Explanation of R squared and log(B0B1) Results:**

**Calculating Confidence Intervals:**

``` r
confidence_r2 = bootstrap_results%>%
  summarize(
    ci_lower = quantile(r.squared,0.025), 
    ci_upper = quantile(r.squared,0.975))

confidence_log = bootstrap_results%>%
  summarize(
    ci_lower = quantile(log,0.025), 
    ci_upper = quantile(log,0.975))

confidence_r2%>%
  knitr::kable(caption = "95% Confidence Interval for R Squared", format = "html", digits = 3)
```

<table>

<caption>

95% Confidence Interval for R Squared

</caption>

<thead>

<tr>

<th style="text-align:right;">

ci\_lower

</th>

<th style="text-align:right;">

ci\_upper

</th>

</tr>

</thead>

<tbody>

<tr>

<td style="text-align:right;">

0.894

</td>

<td style="text-align:right;">

0.927

</td>

</tr>

</tbody>

</table>

``` r
confidence_log%>%
  knitr::kable(caption = "95% Confidence Interval for log(B0*B1)", format = 'html', digits = 3)
```

<table>

<caption>

95% Confidence Interval for log(B0\*B1)

</caption>

<thead>

<tr>

<th style="text-align:right;">

ci\_lower

</th>

<th style="text-align:right;">

ci\_upper

</th>

</tr>

</thead>

<tbody>

<tr>

<td style="text-align:right;">

1.966

</td>

<td style="text-align:right;">

2.06

</td>

</tr>

</tbody>

</table>
